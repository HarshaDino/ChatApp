<!doctype html>
<html>
  <head>
    <meta charset='utf-8'/>
    <title>Django RAG Chat Demo</title>
    <style>
      body { font-family: Arial, Helvetica, sans-serif; max-width: 900px; margin: 20px auto; }
      .chat { border: 1px solid #ddd; padding: 12px; height: 400px; overflow-y: auto; background: #fafafa; }
      .msg { margin: 8px 0; }
      .user { text-align: right; }
      .ai { text-align: left; color: #222; }
      .meta { font-size: 12px; color: #666; }
      .controls { margin-top: 12px; display:flex; gap:8px; }
    </style>
  </head>
  <body>
    <h2>Django RAG Chat (minimal)</h2>
    <p>Upload documents (PDF, DOCX, TXT) and ask questions based on uploaded documents. No OpenAI API required.</p>

    <div>
      <form id="upload-form">
        <input type="file" name="file" id="file-input" />
        <button type="submit">Upload</button>
      </form>
    </div>

    <div class="chat" id="chat-window"></div>

    <div class="controls">
      <input type="text" id="question" placeholder="Ask a question..." style="flex:1" />
      <button id="ask">Ask</button>
    </div>

    <script>
      async function uploadFile(file) {
        const fd = new FormData();
        fd.append('file', file);
        const res = await fetch('/api/upload/', { method: 'POST', body: fd });
        return res.json();
      }
      async function askQuestion(q) {
        const res = await fetch('/api/chat/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({question: q}) });
        return res.json();
      }

      const chatWindow = document.getElementById('chat-window');
      function addMessage(text, who='ai') {
        const div = document.createElement('div');
        div.className = 'msg ' + (who==='user' ? 'user' : 'ai');
        div.innerHTML = '<div class="meta">' + (who==='user' ? 'You' : 'AI') + '</div><div>' + (text || '') + '</div>';
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      document.getElementById('upload-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const f = document.getElementById('file-input').files[0];
        if (!f) return alert('Pick a file first');
        addMessage('Uploading: ' + f.name, 'user');
        const res = await uploadFile(f);
        if (res && res.id) {
          addMessage('Uploaded: ' + (res.original_name || res.file), 'ai');
        } else {
          addMessage('Upload failed: ' + JSON.stringify(res), 'ai');
        }
      });

      document.getElementById('ask').addEventListener('click', async () => {
        const q = document.getElementById('question').value.trim();
        if (!q) return;
        addMessage(q, 'user');
        addMessage('...', 'ai');
        const res = await askQuestion(q);
        // replace last '...' message
        const msgs = chatWindow.querySelectorAll('.msg');
        const last = msgs[msgs.length-1];
        if (res.answer) {
          last.innerHTML = '<div class="meta">AI</div><div>' + (res.answer.replace(/\n/g, '<br/>')) + '</div>';
        } else {
          last.innerHTML = '<div class="meta">AI</div><div>Error: ' + JSON.stringify(res) + '</div>';
        }
      });
    </script>
  </body>
</html>
